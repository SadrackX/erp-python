

<script>
    var pedido = {{ pedido | tojson | safe }} || null;
    var produtosPedido = pedido && pedido.itens ? pedido.itens : [];
    var cliente = {{ cliente | tojson | safe }} || null;
    var produtos = {{ produtos | tojson | safe }} || [];
    var valorTotal;
    let indexEditando = null;  // variável de controle global

    function editarPedidoForm() {
        if (!pedido) return;

        $('#pedido-id').val(pedido.id);
        $('#status').val(pedido.status);
        $('#id_cliente').val(pedido.id_cliente);

        if (pedido.data_previsao_entrega) {
            $('#data_previsao_entrega').val(pedido.data_previsao_entrega.split('T')[0]);
        }

        produtosPedido = produtos;
    }

    document.getElementById('status').addEventListener('change', function() {
        const valorSelecionado = this.value;
        const inputContainer = document.getElementById('data_previsao_entrega');
        const mensagem = document.getElementById('data_previsao_entrega_mensagem');

        if (valorSelecionado === 'Rascunho') {
        inputContainer.disabled = true;
        mensagem.style.display = 'block';
        } else {
        inputContainer.disabled = false;
        mensagem.style.display = 'none';
        }
    });

    // Executa no carregamento da página também (opcional)
    window.addEventListener('DOMContentLoaded', function () {
        document.getElementById('status').dispatchEvent(new Event('change'));
    });


    $(document).ready(function () {
        atualizarTabelaProdutos();
        // Preenche cliente no formulário (edição)

        // Cliente autocomplete CNPJ
        $('#cpf_cnpj').on('input', function () {
            var termo = $(this).val();
            if (termo.length < 3) { $('#sugestoes-clientes').hide(); return; }
            $.getJSON("{{ url_for('clientes.buscar') }}", { q: termo }, function (res) {
                var html = '';
                res.forEach(function (c) {
                    html += '<div class="sugestao-cliente" data-json="' + encodeURIComponent(JSON.stringify(c)) + '">' +
                            '<strong>' + c.nome + '</strong><br>' +
                            '<small class="text-muted">' + c.cpf_cnpj + '</small>' +
                            '</div>';
                });
                $('#sugestoes-clientes').html(html).show();
            });
        });

        $('#cpf_cnpj').focusout(function () {
            setTimeout(function () { $('#sugestoes-clientes').hide(); }, 200);
        });

        $(document).on('click', '.sugestao-cliente', function () {
            const inputCPF_CNPJ = document.getElementById('cpf_cnpj');
            var c = JSON.parse(decodeURIComponent($(this).data('json')));
            $('#id_cliente').val(c.id);
            $('#nome').val(c.nome);
            $('#tipo').val(c.tipo);
            $('#cpf_cnpj').val(c.cpf_cnpj);
            $('#email').val(c.email);
            $('#celular').val(c.celular);
            $('#endereco').val(c.endereco);
            $('#numero').val(c.numero);
            $('#bairro').val(c.bairro);
            $('#cidade').val(c.cidade);
            $('#cep').val(c.cep);
            $('#uf').val(c.uf);
            $('#sugestoes-clientes').hide();
            inputCEP.classList.remove('is-invalid');
            inputCelular.classList.remove('is-invalid');
            inputCPF_CNPJ.classList.remove('is-invalid');
        });

        // Cliente autocomplete NOME
        $('#nome').on('input', function () {
            var termo = $(this).val();
            if (termo.length < 3) { $('#sugestoes-clientes_nome').hide(); return; }
            $.getJSON("{{ url_for('clientes.buscar') }}", { q: termo }, function (res) {
                var html = '';
                res.forEach(function (c) {
                    html += '<div class="sugestao-cliente" data-json="' + encodeURIComponent(JSON.stringify(c)) + '">' +
                        '<strong>' + c.nome + '</strong><br>' +
                        '<small class="text-muted">' + c.cpf_cnpj + '</small>' +
                        '</div>';
                });
                $('#sugestoes-clientes_nome').html(html).show();
            });
        });

        $('#nome').focusout(function () {
            setTimeout(function () { $('#sugestoes-clientes_nome').hide(); }, 200);
        });

        $(document).on('click', '.sugestoes-clientes_nome', function () {
            const inputCPF_CNPJ = document.getElementById('cpf_cnpj');
            var c = JSON.parse(decodeURIComponent($(this).data('json')));
            $('#id_cliente').val(c.id);
            $('#nome').val(c.nome);
            $('#tipo').val(c.tipo);
            $('#cpf_cnpj').val(c.cpf_cnpj);
            $('#email').val(c.email);
            $('#celular').val(c.celular);
            $('#endereco').val(c.endereco);
            $('#numero').val(c.numero);
            $('#bairro').val(c.bairro);
            $('#cidade').val(c.cidade);
            $('#cep').val(c.cep);
            $('#uf').val(c.uf);
            $('#sugestoes-clientes_nome').hide();
            inputCEP.classList.remove('is-invalid');
            inputCelular.classList.remove('is-invalid');
            inputCPF_CNPJ.classList.remove('is-invalid');
        });

        // Produto autocomplete
        $('#abrir-modal-produto').on('click', function () {
            $('#busca-produto').val('').focus();
            $('#preco-produto').val('');
            $('#quantidade-produto').val(1);
            $('#sugestoes-produtos').hide();
            $('#largura-produto').val('');
            $('#altura-produto').val('');
            document.getElementById('medida-produto').selectedIndex = 1;
            document.getElementById('calculo').checked = false;
        }); 

        $('#busca-produto').on('input', function () {
            var termo = $(this).val();
            if (termo.length < 2) { $('#sugestoes-produtos').hide(); return; }
            $.getJSON("{{ url_for('produtos.buscar') }}", { q: termo }, function (res) {
                var html = '';
                res.forEach(function (p) {
                    html += '<div class="sugestao-produto" data-json="'+encodeURIComponent(JSON.stringify(p))+'">' + p.nome + ' (R$ ' + p.preco_venda + ')</div>';
                });
                $('#sugestoes-produtos').html(html).show();
            });
        });

        $('#busca-produto').focusout(function () {
            setTimeout(function () { $('#sugestoes-produtos').hide(); }, 200);
        });

        $(document).on('click', '.sugestao-produto', function () {
            var p = JSON.parse(decodeURIComponent($(this).data('json')));
            $('#busca-produto').val(p.nome);
            $('#preco-produto').val(p.preco_venda);
            $('#sugestoes-produtos').hide();
        });

        // Adicionar produto
        $('#adicionar-produto').on('click', function () {
            //e.preventDefault();

            var nome = $('#busca-produto').val();
            var preco = parseFloat($('#preco-produto').val());
            var qtd = parseInt($('#quantidade-produto').val());

            if (document.getElementById('calculo').checked) {
                var largura = parseFloat($('#largura-produto').val());
                var altura = parseFloat($('#altura-produto').val());
                var medida = $('#medida-produto').val();
                nome += " [ " + largura + " X " + altura + " " + medida + " ]";
                if (document.getElementById('medida-produto').value === 'MM') {
                    preco *= largura * altura * 0.000001;
                } else if (document.getElementById('medida-produto').value === 'CM')
                    preco *= largura * altura * 0.0001;
                else if (document.getElementById('medida-produto').value === 'M') {
                    preco *= largura * altura;
                }
            }

            if (!nome || isNaN(preco) || isNaN(qtd) || qtd < 1) {
                alert('Preencha todos os campos corretamente!');
                return;
            }
          
            const novoProduto = {
                nome: nome,
                preco_unitario: preco,
                quantidade: qtd
            };

            // EDITAR PRODUTO
            if (indexEditando !== null) {
                produtosPedido[indexEditando] = novoProduto;
                indexEditando = null;
            } else {
                produtosPedido.push(novoProduto);
            }

            atualizarTabelaProdutos();
            $('#modal-produto').modal('hide');
        });
    });
    
    // TABELA DE PRODUTOS
    function atualizarTabelaProdutos() {
        var html = '';
        var totalPedido = 0;
        produtosPedido.forEach(function(p, idx) {
            var total = p.preco_unitario * p.quantidade;
            totalPedido += total;
            html += '<tr>';
            html += '<td>'+p.nome+'</td>';
            html += '<td>' + new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(p.preco_unitario).replace('R$', 'R$') + '</td>';
            html += '<td>'+p.quantidade+'</td>';
            html += '<td>' + new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(total).replace('R$', 'R$') + '</td>';
            html += '<td>';
            html += '<button type="button" class="btn btn-sm btn-outline-primary mr-1" data-toggle="modal" data-target="#modal-produto" onclick="editarProduto('+idx+')"><span class="material-icons">edit</span></button>';
            html += '<button type="button" class="btn btn-sm btn-outline-danger" onclick="removerProduto('+idx+')"><span class="material-icons">delete</span></button>';
            html += '</td>';
            html += '</tr>';
            
        });
        valorTotal = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalPedido).replace('R$', 'R$');
        $('#tabela-produtos tbody').html(html);
        $('#valor-final').text(valorTotal);
        $('#produtos_json').val(JSON.stringify(produtosPedido));
    }

    function removerProduto(index) {
        produtosPedido.splice(index, 1);
        atualizarTabelaProdutos();
    }

    // EDITAR PRODUTO
    function editarProduto(index) {
        const p = produtosPedido[index];
        indexEditando = index;

        $('#busca-produto').val(p.nome);
        $('#preco-produto').val(p.preco_unitario);
        $('#quantidade-produto').val(p.quantidade);        

        separarProdutoEMedidas(p.nome,p.preco_unitario);
        
        $('#modal-produto').modal('show');
    }

    editarPedidoForm();
    document.getElementById('valor_pago').addEventListener('input', function () {
        const inputValorPago = $('#valor_pago').val();
        if(inputValorPago > valorTotal){
            $('#valor_pago').val(valorTotal);
        } else if (inputValorPago < 0){
                $('#valor_pago').val(0);
        }
    });

    function separarProdutoEMedidas(nomeProduto, preco_unitario) {
        const inputText = nomeProduto.trim();
        
        // 1. Verifica se tem colchetes e extrai o conteúdo
        const regexMedidas = /\[([^\]]+)\]/;
        const matchMedidas = inputText.match(regexMedidas);
        
        // Se NÃO estiver no formato [MEDIDAS], sai sem alterar nada
        if (!matchMedidas) {
            console.log("Produto sem medidas no formato [LARGURA X ALTURA UNIDADE]. Nenhum campo alterado.");
            return false; // Retorna false para indicar que não houve alteração
        }

        const conteudoColchetes = matchMedidas[1].trim();
        
        // 2. Tenta separar LARGURA X ALTURA UNIDADE
        const partes = conteudoColchetes.split(/\s*[xX]\s*/); // Suporta "X", "x" ou "×" com espaços opcionais
        
        // Se não tiver duas medidas (LARGURA e ALTURA), sai sem alterar
        if (partes.length !== 2) {
            console.log("Formato de medidas inválido. Nenhum campo alterado.");
            return false;
        }

        // 3. Extrai medidas e unidade
        const medida1 = partes[0].trim();
        const medida2Partes = partes[1].trim().split(/\s+/);
        const unidade = medida2Partes.pop().toUpperCase(); // Garante unidade em maiúsculas (MM, CM, M)
        const medida2 = medida2Partes.join(' ');

        // 4. Verifica se medidas são números válidos
        if (isNaN(medida1) || isNaN(medida2)) {
            console.log("Medidas inválidas (não são números). Nenhum campo alterado.");
            return false;
        }

        // 5. Verifica se a unidade é suportada (MM, CM, M)
        const unidadesSuportadas = ["MM", "CM", "M"];
        if (!unidadesSuportadas.includes(unidade)) {
            console.log(`Unidade "${unidade}" não suportada. Nenhum campo alterado.`);
            return false;
        }

        // 6. Só aqui, se tudo estiver válido, atualiza os campos!
        $('#busca-produto').val(inputText.split('[')[0].trim()); // Nome do produto sem as medidas
        $('#largura-produto').val(medida1);
        $('#altura-produto').val(medida2);
        
        // Define a unidade no <select> (assumindo que as opções estão na ordem MM, CM, M)
        const indexUnidade = unidadesSuportadas.indexOf(unidade);
        document.getElementById('medida-produto').selectedIndex = indexUnidade;
        
        // Calcula preço por área (ajuste conforme sua lógica)
        let areaEmMetrosQuadrados;
        switch(unidade) {
            case 'MM':
                areaEmMetrosQuadrados = (medida1 * medida2) / 1000000; // mm² → m²
                break;
            case 'CM':
                areaEmMetrosQuadrados = (medida1 * medida2) / 10000; // cm² → m²
                break;
            case 'M':
                areaEmMetrosQuadrados = medida1 * medida2; // já em m²
                break;
        }
        
        const precoCalculado = preco_unitario / areaEmMetrosQuadrados;
        $('#preco-produto').val(precoCalculado.toFixed(2)); // Formata com 4 decimais
        
        document.getElementById('calculo').checked = true;
        return true; // Indica que os campos foram alterados
    }
        
    function finalizarPedido() {
        var valorPago = document.getElementById('valor_pago').value;
        if (!valorPago && valorTotal != 0) {
            alert('Por favor, informe o valor pago.');
            return;
        } else if (isNaN(valorPago) || valorPago < 0 && valorTotal === 0) {
            alert('Por favor, informe um valor pago válido.');
            return;
        } else if (valorPago < valorTotal) {
            alert('O valor pago deve ser maior ou igual ao total do pedido.');
            return;
        } else if (valorPago > valorTotal) {
            alert('O valor pago não pode ser maior que o total do pedido.');
            return;
        } else if (confirm("Tem certeza que deseja FINALIZAR o pedido?")) {
            document.getElementById('status').value = 'Finalizado';
            document.getElementById('pedido-form').submit();
        }
    }

    // -----------------SOMENTE EM ORÇAMENTO-----------------
    function gerarOrcamento() {
        if (confirm("Tem certeza que deseja gerar o orçamento como Rascunho?")) {
            document.getElementById('status').value = 'Rascunho';
            document.getElementById('orcamento-form').submit();
        }
    }
    
</script>