{% extends 'base.html' %}
{% block conteudo %}
<br />
<div class="noselect">
<div class="d-flex justify-content-between align-items-center py-3">
    <h3 class="mb-4">Dashboard de Pedidos</h3>
    <div>
        <a href="{{ url_for('orcamentos.novo') }}" class="btn btn-outline-dark">Novo Orçamento</a>
        <a href="{{ url_for('pedidos.novo') }}" class="btn btn-outline-primary">Novo Pedido</a>
    </div>
</div>

{% set status_lista = ['Design', 'Produção', 'Pronto', 'Orçamento', 'Rascunho', 'Atrasado'] %}
{% set status_classes = {
    'Rascunho': 'secondary',
    'Design': 'primary',
    'Produção': 'info',
    'Pronto': 'success',
    'Orçamento': 'dark',
    'Atrasado': 'danger'
} %}

{# --- Tabela das Entregas mais próximas --- #}
<div class="card mb-5 shadow-sm">
    <div class="card-header bg-warning text-white">
        <strong>🕒 Próximas Entregas</strong>
    </div>
    <div class="card-body p-0 table-responsive">
        <table class="table table-hover table-sm mb-0">
            <thead class="table-light"></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<hr>         <!-- ------------------------------------------------------------- -->

<div class="row">
    {% for status in status_lista %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card shadow-sm h-100">
            <div id="card-{{ status }}" class="card-header bg-{{ status_classes[status] }} text-white">
                <strong>{{ status }}</strong>
            </div>
            <div class="card-body p-0 table-responsive">
                <table class="table table-hover table-sm mb-0">
                    <thead id="h-status-{{ status }}" class="table-light">

                    </thead>
                    <tbody id="status-{{ status }}">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<hr>       <!-- ------------------------------------------------------------- -->

{# --- Tabela das Entregas mais próximas --- #}
<div class="card mb-5 shadow-sm">
    <div class="card-header bg-success text-white">
        <strong>Pedido Finalizado</strong>
    </div>
    <div class="card-body p-0 table-responsive">
        <table class="table table-hover table-sm mb-0">
            <thead class="table-light">
                <tr>
                    <th>Cliente</th>
                    <th>Criado</th>
                    <th>Entrega</th>
                    <th>Valor Total</th>
                    <th>Restante</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% set entregas_finalizadas = pedidos
                | selectattr('status', 'equalto', 'Finalizado')
                | selectattr('data_previsao_entrega')
                | sort(attribute='data_previsao_entrega', reverse=true)
                | list
                %}
                {% for pedido in entregas_finalizadas[:10] if pedido.status == 'Finalizado' %}
                <tr class="{{ 'table-danger' if pedido.valor_pago < pedido.total}}" style="cursor: pointer;">
                    <td onclick="window.location='{{ url_for('pedidos.editar', pedido_id=pedido.id) }}'" class="text-truncate" style="max-width: 400px;">{{ clientes[pedido.id_cliente] if clientes[pedido.id_cliente] else pedido.id_cliente }}</td>
                    <td onclick="window.location='{{ url_for('pedidos.editar', pedido_id=pedido.id) }}'">{{ pedido.data.strftime('%d/%m %H:%M') if pedido.data else '' }}</td>
                    <td onclick="window.location='{{ url_for('pedidos.editar', pedido_id=pedido.id) }}'">{{ pedido.data_previsao_entrega.strftime('%d/%m %H:%M') if pedido.data_previsao_entrega else '' }}</td>
                    <td onclick="window.location='{{ url_for('pedidos.editar', pedido_id=pedido.id) }}'">R$ {{ "{:,.2f}".format(pedido.total).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    {% if pedido.valor_pago != pedido.total %}
                        <td style="color: darkred;" onclick="window.location='{{ url_for('pedidos.editar', pedido_id=pedido.id) }}'"><b>R$ {{ "{:,.2f}".format(pedido.total-pedido.valor_pago).replace(",", "X").replace(".", ",").replace("X", ".") }}</b></td>
                    {% else %}
                    <td></td>
                    {% endif %}
                    <td style="width: 200px;">
                        <a class="btn btn-outline-dark btn-sm" style="width: 70px; height: 35px;" href="{{ url_for('gerar_pdf.gerar', pedido_id=pedido.id, tipo='recibo') }}" target="_blank"><span style="font-size: 25px;" class="material-icons">local_printshop</span></a>
                        {% if pedido.valor_pago != pedido.total %}
                            <a class="btn btn-primary btn-sm" style="width: 70px; height: 35px; color: azure;" onclick="abrirModalFinalizarPedido({{pedido.to_dict() | safe}})" target="_blank">Finalizar</a>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center text-muted">Nenhuma entrega Finalizada</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% include 'partials/modal_finalizar_pedido.html' %}
{% include 'partials/scriptDashboard.html' %}
</div>
{% endblock %}
