{% extends 'base.html' %}
{% block conteudo %}
    <h3>Cadastrar Pedido</h3>
    <form id="pedido-form" method="post" action="{{ url_for('pedidos_novo') }}">
        <!-- Buscador de Cliente -->
        <label>Buscar Cliente:</label><br>
        <input type="text" id="busca-cliente" placeholder="Nome, CPF ou CNPJ" autocomplete="off" required>
        <div id="sugestoes-clientes" style="background:#fff; border:1px solid #ccc; display:none; position:absolute; z-index:10;"></div>
        <br>
        <!-- Tabela de informações do cliente -->
        <table id="info-cliente" border="1" cellpadding="5" style="margin-bottom:16px; display:none;">
            <tr><th>Nome</th><th>Tipo</th><th>CPF/CNPJ</th><th>Email</th><th>Telefone</th><th>Endereço</th><th>Bairro</th><th>Cidade</th><th>CEP</th><th>UF</th></tr>
            <tr id="cliente-dados"></tr>
        </table>
        <input type="hidden" name="id_cliente" id="id_cliente" required>
        <!-- Produtos do Pedido -->
        <label>Adicionar Produto:</label>
        <button type="button" id="abrir-modal-produto" data-toggle="modal" data-target="#modal-produto">Adicionar Produto</button>
        <br><br>
        {% include 'partials/tabela_itens_pedido.html' %}
        <!-- Status e valor final -->
        <label>Status:</label><br>
        <select name="status" required>
            <option value="rascunho">Rascunho</option>
            <option value="finalizado">Finalizado</option>
            <option value="cancelado">Cancelado</option>
        </select><br>
        <label>Valor Final do Pedido:</label>
        <span id="valor-final">R$ 0,00</span><br>
        <input type="hidden" name="produtos_json" id="produtos_json">
        <input type="submit" value="Salvar">
    </form>
    {% include 'partials/modal_produto_pedido.html' %}
    <a href="{{ url_for('pedidos') }}">Voltar para lista de pedidos</a>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    // --- Cliente autocomplete ---
    $('#busca-cliente').on('input', function() {
        var termo = $(this).val();
        if (termo.length < 2) { $('#sugestoes-clientes').hide(); return; }
        $.getJSON('{{ url_for('buscar_clientes') }}', {q: termo}, function(res) {
            var html = '';
            res.forEach(function(c) {
                html += '<div class="sugestao-cliente" data-id="'+c.id+'" data-json="'+encodeURIComponent(JSON.stringify(c))+'">'+c.nome+' ('+c.cpf_cnpj+')</div>';
            });
            $('#sugestoes-clientes').html(html).show();
        });
    });
    $(document).on('click', '.sugestao-cliente', function() {
        var c = JSON.parse(decodeURIComponent($(this).data('json')));
        $('#id_cliente').val(c.id);
        var row = '';
        row += '<td>'+c.nome+'</td>';
        row += '<td>'+c.tipo+'</td>';
        row += '<td>'+c.cpf_cnpj+'</td>';
        row += '<td>'+c.email+'</td>';
        row += '<td>'+c.celular+'</td>';
        row += '<td>'+c.endereco+'</td>';
        row += '<td>'+c.bairro+'</td>';
        row += '<td>'+c.cidade+'</td>';
        row += '<td>'+c.cep+'</td>';
        row += '<td>'+c.uf+'</td>';
        $('#cliente-dados').html(row);
        $('#info-cliente').show();
        $('#sugestoes-clientes').hide();
        $('#busca-cliente').val(c.nome);
    });
    // --- Produto autocomplete/modal ---
    $('#abrir-modal-produto').on('click', function() {
        $('#modal-produto').show();
        $('#busca-produto').val('').focus();
        $('#preco-produto').val('');
        $('#quantidade-produto').val(1);
        $('#sugestoes-produtos').hide();
    });
    $('#fechar-modal-produto').on('click', function() {
        $('#modal-produto').hide();
    });
    $('#busca-produto').on('input', function() {
        var termo = $(this).val();
        if (termo.length < 2) { $('#sugestoes-produtos').hide(); return; }
        $.getJSON('{{ url_for('buscar_produtos') }}', {q: termo}, function(res) {
            var html = '';
            res.forEach(function(p) {
                html += '<div class="sugestao-produto" data-id="'+p.id+'" data-json="'+encodeURIComponent(JSON.stringify(p))+'">'+p.nome+' (R$ '+p.preco_venda+')</div>';
            });
            $('#sugestoes-produtos').html(html).show();
        });
    });
    $(document).on('click', '.sugestao-produto', function() {
        var p = JSON.parse(decodeURIComponent($(this).data('json')));
        $('#preco-produto').val(p.preco_venda);
        $('#busca-produto').val(p.nome);
        $('#busca-produto').data('produto', p);
        $('#sugestoes-produtos').hide();
    });
    // --- Adicionar produto à tabela ---
    var produtosPedido = [];
    function atualizarTabelaProdutos() {
        var html = '';
        var totalPedido = 0;
        produtosPedido.forEach(function(p, idx) {
            var total = p.preco_unitario * p.quantidade;
            totalPedido += total;
            html += '<tr>';
            html += '<td>'+p.nome+'</td>';
            html += '<td>R$ '+p.preco_unitario.toFixed(2)+'</td>';
            html += '<td>'+p.quantidade+'</td>';
            html += '<td>R$ '+total.toFixed(2)+'</td>';
            html += '<td><button type="button" onclick="removerProduto('+idx+')">Remover</button></td>';
            html += '</tr>';
        });
        $('#tabela-produtos tbody').html(html);
        $('#valor-final').text('R$ '+totalPedido.toFixed(2));
        $('#produtos_json').val(JSON.stringify(produtosPedido));
    }
    window.removerProduto = function(idx) {
        produtosPedido.splice(idx, 1);
        atualizarTabelaProdutos();
    }
    $('#adicionar-produto').on('click', function() {
        var p = $('#busca-produto').data('produto');
        if (!p) { alert('Selecione um produto!'); return; }
        var preco = parseFloat($('#preco-produto').val());
        var qtd = parseInt($('#quantidade-produto').val());
        if (isNaN(preco) || isNaN(qtd) || qtd < 1) { alert('Preencha preço e quantidade!'); return; }
        produtosPedido.push({
            id_produto: p.id,
            nome: p.nome,
            preco_unitario: preco,
            quantidade: qtd
        });
        atualizarTabelaProdutos();
        $('#modal-produto').hide();
    });
    </script>
{% endblock %}
