{% extends 'base.html' %}
{% block conteudo %}
<!-- Novo Pedido -->
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <br>
            <h5>
                {% if pedido %}
                    {% if pedido.status == 'Orçamento' %}
                        Editar Orçamento ID: {{ pedido['id'] }}
                    {% else %}
                        Editar Pedido ID: {{ pedido['id'] }}
                    {% endif %}
                {% else %}
                    Novo Pedido
                {% endif %}
            </h5>
            <hr>
            <form id="pedido-form" method="post" action="{{ url_for('pedido_editar', pedido_id=pedido['id']) if pedido and pedido['status'] != 'Finalizado' else url_for('pedidos_novo') }}" autocomplete="off">
                {% include 'partials/form_cliente.html' %}
                <hr>
                <div class="form-row">
                    <!-- Produtos do Pedido -->
                    <button type="button" class="btn btn-primary" id="abrir-modal-produto"  data-toggle="modal" data-target="#modal-produto">Adicionar Produto</button>
                    <table id="tabela-produtos" class="table table-striped" border="1" cellpadding="5" cellspacing="0">
                        <thead>
                            <tr>
                                <th scope="col">Nome</th>
                                <th scope="col" style="width: 15%;">Preço Unitário</th>
                                <th scope="col" style="width: 10%;">Quantidade</th>
                                <th scope="col" style="width: 15%;">Total</th>
                                <th scope="col" style="width: 20px;"></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Status e valor final -->
                <div class="form-row" >
                    <div class="form-group col-md-3">
                        <label for="status">Status:</label>
                        <select id="status" name="status" required class="form-control">
                            <option value="Orçamento" hidden>Orçamento</option>  
                            <option value="Atrasado" hidden>Atrasado</option>  
                            <option value="Finalizado" hidden>Finalizado</option> 
                            <option value="Cancelado" hidden>Cancelado</option> 
                            <option value="Rascunho" {% if pedido and pedido.status == 'Rascunho' %}selected{% endif %}>Rascunho</option>
                            <option value="Design" {% if pedido and pedido.status == 'Design' %}selected{% endif %}>Design</option>
                            <option value="Produção" {% if pedido and pedido.status == 'Produção' %}selected{% endif %}>Produção</option>
                        </select>
                    </div>

                    <div class="form-group col-md-3">
                        <label for="data_previsao_entrega">Data Prevista de Entrega:</label>
                        <input type="date" class="form-control" id="data_previsao_entrega" name="data_previsao_entrega"
                               value="{{ pedido['data_previsao_entrega'] if pedido and pedido.get('data_previsao_entrega') else '' }}">
                               <small id="data_previsao_entrega_mensagem" class="text-danger" style="display: none;">Data de entrega não disponivel em Rascunho!</small>

                    </div>
                    <div class="form-group col-md-3">
                        <label for="forma_de_pagamento">Forma de Pagamento:</label>
                        <select id="forma_de_pagamento" name="forma_de_pagamento" required class="form-control">
                            <option value="Dinheiro/Pix" {% if pedido and pedido.forma_de_pagamento == 'Dinheiro/Pix' %}selected{% endif %} {% if pedido %}selected{% endif %} >Dinheiro/Pix</option>
                            <option value="Cartão" {% if pedido and pedido.forma_de_pagamento == 'Cartão' %}selected{% endif %}>Cartão</option>
                            <option value="Outro" {% if pedido and pedido.forma_de_pagamento == 'Outro' %}selected{% endif %}>Outro</option>
                        </select>
                    </div>
                    <div class="form-group col-md-3">
                        <label for="valor_pago">Valor Pago:</label>
                        <input type="number" name="valor_pago" id="valor_pago" class="form-control mb-2" step="0.01" value="{{ pedido['valor_pago'] if pedido else '0' }}">
                    </div>
                </div>

                <div class="form-group">
                    <label>Valor Final do Pedido:</label>
                    <span id="valor-final">R$ 0,00</span><br>
                </div>
                
                <input type="hidden" name="id_pedido" id="pedido-id" value="{{ pedido['id'] if pedido else '' }}">
                <input type="hidden" name="produtos_json" id="produtos_json">
                <input type="hidden" name="id_cliente" id="id_cliente" value="{{ pedido['id_cliente'] if pedido else 'novo' }}">
                <input type="hidden" name="next" value="{{ request.referrer }}">

                <hr>
                <div class="container" style="text-align: right;">
                    <div class="btn-group">
                        <button class="btn btn-warning dropdown-toggle" data-toggle="dropdown">
                            Imprimir
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="{{ url_for('gerar_pdf_pedido', pedido_id=pedido['id'], tipo='orcamento') }}" target="_blank">Orçamento</a>
                            <a class="dropdown-item" href="{{ url_for('gerar_pdf_pedido', pedido_id=pedido['id'], tipo='ordem_servico') }}" target="_blank">Ordem de Serviço</a>
                            <a class="dropdown-item" href="{{ url_for('gerar_pdf_pedido', pedido_id=pedido['id'], tipo='recibo') }}" target="_blank">Recibo</a>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="finalizarPedido()" {% if not pedido or pedido.status not in ['Design', 'Produção', 'Atrasado'] %}hidden{% endif %}>Finalizar</button> 
                    <a href="{{ url_for('pedidos') }}" class="btn btn-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-success">
                        {% if not pedido  or pedido.status == 'Finalizado' %}
                            Novo Pedido
                        {% else %}
                            Salva Pedido
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% include 'partials/modal_produto_pedido.html' %}
{% include 'partials/scriptFormPedido.html' %}
{% include 'partials/scriptFormCliente.html' %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var selectStatus = document.getElementById('status');
        var inputValorPago = document.getElementById('valor_pago');
        if (selectStatus && ['Orçamento', 'Cancelado','Finalizado'].includes(selectStatus.value)) {
            selectStatus.value = 'Rascunho';
            inputValorPago.value = 0.0;            
        }
    });
</script>


{% endblock %}